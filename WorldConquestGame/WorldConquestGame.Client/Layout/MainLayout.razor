@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject WorldConquestGame.Client.Services.StorageService StorageService
@inject WorldConquestGame.Client.Services.UkCountyGameService CountyGameService
@implements IDisposable

<div class="page">
    <main>
        <div class="top-row px-4">
            <a href="/" class="page-title-link">
                <h1 class="page-title">
                    <i class="bi bi-globe"></i> World Conquest
                </h1>
            </a>
            @if (ShouldShowContinentButtons)
            {
                <nav class="continent-buttons ms-3">
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("Africa")' aria-label="Zoom to Africa">
                        <i class="bi bi-map-fill"></i> Africa
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("Europe")' aria-label="Zoom to Europe">
                        <i class="bi bi-map-fill"></i> Europe
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("Asia")' aria-label="Zoom to Asia">
                        <i class="bi bi-map-fill"></i> Asia
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("North America")' aria-label="Zoom to North America">
                        <i class="bi bi-map-fill"></i> N. America
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("South America")' aria-label="Zoom to South America">
                        <i class="bi bi-map-fill"></i> S. America
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToContinent("Oceania")' aria-label="Zoom to Oceania">
                        <i class="bi bi-map-fill"></i> Oceania
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-2" @onclick='() => ZoomToContinent("Antarctica")' aria-label="Zoom to Antarctica">
                        <i class="bi bi-map-fill"></i> Antarctica
                    </button>
                    <button class="btn btn-sm geo-reset-btn" @onclick="ResetAndGoToMap" aria-label="Reset saved map">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </nav>
            }
            else if (IsUkCountiesMode)
            {
                <nav class="continent-buttons ms-3">
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToUkRegion("England")' aria-label="Zoom to England">
                        <i class="bi bi-geo-alt-fill"></i> England
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToUkRegion("Scotland")' aria-label="Zoom to Scotland">
                        <i class="bi bi-geo-alt-fill"></i> Scotland
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToUkRegion("Wales")' aria-label="Zoom to Wales">
                        <i class="bi bi-geo-alt-fill"></i> Wales
                    </button>
                    <button class="btn btn-sm geo-continent-btn me-2" @onclick='() => ZoomToUkRegion("Northern Ireland")' aria-label="Zoom to Northern Ireland">
                        <i class="bi bi-geo-alt-fill"></i> N. Ireland
                    </button>
                    <button class="btn btn-sm geo-reset-btn" @onclick="ResetAndGoToMap" aria-label="Reset saved map">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                </nav>
                }
                else if (IsKentTownsMode)
                {
                    <nav class="continent-buttons ms-3">
                        <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToKentRegion("North Kent")' aria-label="Zoom to North Kent">
                            <i class="bi bi-geo-alt-fill"></i> North Kent
                        </button>
                        <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToKentRegion("East Kent")' aria-label="Zoom to East Kent">
                            <i class="bi bi-geo-alt-fill"></i> East Kent
                        </button>
                        <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToKentRegion("South Kent")' aria-label="Zoom to South Kent">
                            <i class="bi bi-geo-alt-fill"></i> South Kent
                        </button>
                        <button class="btn btn-sm geo-continent-btn me-1" @onclick='() => ZoomToKentRegion("West Kent")' aria-label="Zoom to West Kent">
                            <i class="bi bi-geo-alt-fill"></i> West Kent
                        </button>
                        <button class="btn btn-sm geo-continent-btn me-2" @onclick='() => ZoomToKentRegion("Central Kent")' aria-label="Zoom to Central Kent">
                            <i class="bi bi-geo-alt-fill"></i> Central Kent
                        </button>
                        <button class="btn btn-sm geo-reset-btn" @onclick="ResetAndGoToMap" aria-label="Reset saved map">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </nav>
            }
            <div class="nav-links">
                <a href="map" class="geo-nav-link conquest">
                    <i class="bi bi-crosshair"></i> Conquest
                </a>
                <a href="normal-map" class="geo-nav-link learn">
                    <i class="bi bi-book"></i> Learn
                </a>
            </div>
        </div>

        @code {
            private bool IsUkCountiesMode
            {
                get
                {
                    try
                    {
                        var rel = NavigationManager.ToBaseRelativePath(NavigationManager.Uri)?.TrimEnd('/') ?? string.Empty;
                        return string.Equals(rel, "uk-counties", StringComparison.OrdinalIgnoreCase);
                    }
                    catch
                    {
                        return false;
                    }
                }
            }

                private bool IsKentTownsMode
                {
                    get
                    {
                        try
                        {
                            var rel = NavigationManager.ToBaseRelativePath(NavigationManager.Uri)?.TrimEnd('/') ?? string.Empty;
                            return string.Equals(rel, "kent-towns", StringComparison.OrdinalIgnoreCase);
                        }
                        catch
                        {
                            return false;
                        }
                    }
                }

            private async Task ZoomToUkRegion(string region)
            {
                // This is a placeholder for zooming to a UK region. You can implement mapInterop logic as needed.
                await JS.InvokeVoidAsync("mapInterop.zoomToUkRegion", region);
            }

                private async Task ZoomToKentRegion(string region)
                {
                    // This is a placeholder for zooming to a Kent region. You can implement mapInterop logic as needed.
                    await JS.InvokeVoidAsync("mapInterop.zoomToKentRegion", region);
                }
            private bool ShouldShowContinentButtons
            {
                get
                {
                    try
                    {
                        var rel = NavigationManager.ToBaseRelativePath(NavigationManager.Uri)?.TrimEnd('/') ?? string.Empty;
                        // Only show continent buttons on the main conquest map
                        return string.Equals(rel, "map", StringComparison.OrdinalIgnoreCase);
                    }
                    catch
                    {
                        return false;
                    }
                }
            }

            private async Task ZoomToContinent(string continent)
            {
                // If we're not already on the map page, store the requested continent in sessionStorage
                // and navigate to /map. The map will read the pending value and apply the zoom on init.
                var isOnMap = NavigationManager.Uri?.EndsWith("/map", StringComparison.OrdinalIgnoreCase) == true;
                try
                {
                    if (isOnMap)
                    {
                        await JS.InvokeVoidAsync("mapInterop.zoomToContinent", continent);
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("sessionStorage.setItem", "zoomToContinent", continent);
                        NavigationManager.NavigateTo("/map");
                    }
                }
                catch
                {
                    // Fallback: store request and navigate to map so it will be applied on init
                    await JS.InvokeVoidAsync("sessionStorage.setItem", "zoomToContinent", continent);
                    NavigationManager.NavigateTo("/map");
                }
            }


            private bool showResetModal = false;

            private async Task ResetAndGoToMap()
            {
                try
                {
                    var rel = NavigationManager.ToBaseRelativePath(NavigationManager.Uri)?.TrimEnd('/') ?? string.Empty;
                    if (string.Equals(rel, "uk-counties", StringComparison.OrdinalIgnoreCase))
                    {
                        // Show a confirmation modal before clearing UK counties
                        showResetModal = true;
                        StateHasChanged();
                        return;
                    }

                    // If already on /map, force reload to trigger reset logic
                    if (string.Equals(rel, "map", StringComparison.OrdinalIgnoreCase))
                    {
                        await JS.InvokeVoidAsync("sessionStorage.setItem", "resetMap", "1");
                        await JS.InvokeVoidAsync("location.reload");
                        return;
                    }

                    // Request the map page to perform a reset on load
                    await JS.InvokeVoidAsync("sessionStorage.setItem", "resetMap", "1");
                    NavigationManager.NavigateTo("/map");
                }
                catch { }
            }


            // No longer needed: ShowResetConfirmation

            // Called by confirmation modal when user confirms reset
            private async Task ConfirmReset()
            {
                try
                {
                    await JS.InvokeVoidAsync("console.log", "[Blazor] ConfirmReset called");
                    // Trigger the game service reset event which the uk-counties page listens for
                    CountyGameService.RequestReset();
                    // Also ensure persisted uk counties cleared (service handler in page also clears, but keep this as safety)
                    await StorageService.ClearUkCountiesAsync();
                }
                catch { }
                showResetModal = false;
                StateHasChanged();
            }

            // Subscribe to location changes so the layout can re-render when route changes
            protected override void OnInitialized()
            {
                NavigationManager.LocationChanged += OnLocationChanged;
            }

            private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
            {
                // Re-render to update button visibility
                InvokeAsync(StateHasChanged);
            }

            public void Dispose()
            {
                NavigationManager.LocationChanged -= OnLocationChanged;
            }
        }

        <article class="content px-4">
            @Body
        </article>
        <!-- Confirmation modal for Reset action (Blazor controlled) -->
        @if (showResetModal)
        {
            <div class="modal d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm reset</h5>
                            <button type="button" class="btn-close" @onclick="() => showResetModal = false" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            This will clear your saved progress for UK counties. Are you sure?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="() => showResetModal = false">Cancel</button>
                            <button type="button" class="btn btn-danger" @onclick="ConfirmReset">Clear UK progress</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </main>
</div>