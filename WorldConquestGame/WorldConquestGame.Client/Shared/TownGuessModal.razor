@namespace WorldConquestGame.Client.Shared
@using Microsoft.AspNetCore.Components.Web
@* TownGuessModal.razor: A reusable modal dialog for town/village identification *@

@if (IsOpen)
{
    <div class="modal-backdrop" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;" @onclick="Close">
        <div class="modal-dialog" style="position:fixed;top:2rem;right:2rem;left:auto;transform:none;background:white;padding:2rem;border-radius:8px;min-width:300px;z-index:1100;">
            <h4>@Title</h4>
            <p>@Question</p>
            <input id="town-modal-input" type="text" @bind="UserAnswer" placeholder="Enter town or village name" style="width:100%;margin-bottom:1rem;" @onkeydown="HandleKeyDown" @oninput="OnInputChanged" />
            <div style="display:flex;justify-content:flex-end;gap:1rem;">
                <button type="button" class="btn btn-primary" @onclick="Submit">Submit</button>
                <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
            </div>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div style="color:red;margin-top:1rem;">@ErrorMessage</div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public string Title { get; set; } = "Identify Town or Village";
    [Parameter] public string Question { get; set; } = "What town or village is this?";
    [Parameter] public EventCallback<string> OnSubmit { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public string CorrectAnswer { get; set; } = "";

    private string UserAnswer = "";
    private string ErrorMessage = "";
    private bool wasOpen = false;

    protected override void OnParametersSet()
    {
        // Clear input when modal opens
        if (IsOpen && !wasOpen)
        {
            UserAnswer = "";
            ErrorMessage = "";
        }
        wasOpen = IsOpen;
    }

    private async Task Submit()
    {
        Console.WriteLine($"[Modal] Submit called. UserAnswer={UserAnswer}, CorrectAnswer={CorrectAnswer}");
        if (string.IsNullOrWhiteSpace(UserAnswer))
        {
            ErrorMessage = "Please enter a name.";
            Console.WriteLine("[Modal] Submit: empty input");
            return;
        }
        if (string.Equals(UserAnswer.Trim(), CorrectAnswer.Trim(), StringComparison.OrdinalIgnoreCase))
        {
            ErrorMessage = "";
            Console.WriteLine("[Modal] Submit: correct answer, invoking OnSubmit");
            await OnSubmit.InvokeAsync(UserAnswer);
            await Close();
        }
        else
        {
            ErrorMessage = "Incorrect. Try again or Cancel.";
            Console.WriteLine("[Modal] Submit: incorrect answer");
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Submit();
        }
    }

    private void OnInputChanged(ChangeEventArgs e)
    {
        UserAnswer = e.Value?.ToString() ?? "";
        if (!string.IsNullOrWhiteSpace(UserAnswer))
        {
            ErrorMessage = "";
        }
    }
    private async Task Close()
    {
        Console.WriteLine("[Modal] Close called, invoking OnClose");
        UserAnswer = "";
        ErrorMessage = "";
        await OnClose.InvokeAsync();
    }
}
