@using System.Linq
@using CountryModel = WorldConquestGame.Shared.Models.Country
@inject WorldConquestGame.Client.Services.UkCountyService CountyService
@inject WorldConquestGame.Client.Services.UkCountyGameService CountyGameService
@inject IJSRuntime JS
@implements IDisposable

<div class="counties-component" style="display:flex;flex-direction:column;height:100%;">
    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
        <h4 style="margin:0;flex:0 0 auto;">@Title</h4>
        <input class="form-control" placeholder="Search county" style="flex:1 1 auto;min-width:0;" @bind="_search" />
    </div>

    @if (CountyGameService.Counties == null)
    {
        <p>Loading countiesâ€¦</p>
    }
    else if (!CountyGameService.Counties.Any())
    {
        <p>No counties available.</p>
    }
    else
    {
        <ul class="county-list" style="list-style:none;padding-left:0;margin:0;overflow:auto;flex:1 1 auto;">
            @foreach (var county in Filtered.OrderBy(c => c.Name))
            {
                <li style="padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.03);" @onclick="() => OnCountyClicked(county)">
                    @if (county.IsConquered)
                    {
                        <span class="conquered">@county.Name</span>
                    }
                    else
                    {
                        <span>@county.Name</span>
                    }
                </li>
            }
        </ul>
    }
</div>

<style>
    .counties-component .conquered { text-decoration: line-through; color: #777; }
</style>

@code {
    [Parameter]
    public string Title { get; set; } = "UK Counties";

    private string _search = string.Empty;
    // Use CountyGameService.Counties directly for live updates

    private IEnumerable<CountryModel> Filtered
    {
        get
        {
            if (CountyGameService.Counties == null) return Enumerable.Empty<CountryModel>();
            var query = CountyGameService.Counties.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(_search))
            {
                query = query.Where(c => (c.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));
            }
            return query;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (CountyGameService.Counties == null || CountyGameService.Counties.Count == 0)
        {
            var loaded = await CountyService.GetAllAsync();
            if (loaded != null && loaded.Count > 0)
            {
                CountyGameService.Counties = loaded;
            }
        }
        CountyGameService.CountyConquered += OnCountyConquered;
    }

    // No need to merge on render; always use live reference

    // MergeFromGameService no longer needed

    private async Task OnCountyClicked(CountryModel county)
    {
        if (county == null) return;
        if (!county.IsConquered) return;
        try
        {
            var id = string.IsNullOrWhiteSpace(county.Code) ? county.Name : county.Code;
            if (!string.IsNullOrWhiteSpace(id))
            {
                await JS.InvokeVoidAsync("mapInterop.zoomToCountry", id);
            }
        }
        catch { }
    }

    private void OnCountyConquered(string code)
    {
        StateHasChanged(); // UI will update from CountyGameService.Counties
    }

    public void Dispose()
    {
        CountyGameService.CountyConquered -= OnCountyConquered;
    }
}
