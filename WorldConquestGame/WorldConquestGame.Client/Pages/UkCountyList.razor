@using System.Linq
@using CountryModel = WorldConquestGame.Shared.Models.Country
@inject WorldConquestGame.Client.Services.UkCountyService CountyService
@inject WorldConquestGame.Client.Services.UkCountyGameService CountyGameService
@inject IJSRuntime JS
@implements IDisposable

<div class="counties-component" style="display:flex;flex-direction:column;height:100%;">
    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
        <h4 style="margin:0;flex:0 0 auto;">@Title</h4>
        <input class="form-control" placeholder="Search county" style="flex:1 1 auto;min-width:0;" @bind="_search" />
    </div>

    @if (_counties == null)
    {
        <p>Loading countiesâ€¦</p>
    }
    else if (!_counties.Any())
    {
        <p>No counties available.</p>
    }
    else
    {
        <ul class="county-list" style="list-style:none;padding-left:0;margin:0;overflow:auto;flex:1 1 auto;">
            @foreach (var county in Filtered.OrderBy(c => c.Name))
            {
                <li style="padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.03);" @onclick="() => OnCountyClicked(county)">
                    @if (county.IsConquered)
                    {
                        <span class="conquered">@county.Name</span>
                    }
                    else
                    {
                        <span>@county.Name</span>
                    }
                </li>
            }
        </ul>
    }
</div>

<style>
    .counties-component .conquered { text-decoration: line-through; color: #777; }
</style>

@code {
    [Parameter]
    public string Title { get; set; } = "UK Counties";

    private string _search = string.Empty;
    private List<CountryModel>? _counties;

    private IEnumerable<CountryModel> Filtered
    {
        get
        {
            if (_counties == null) return Enumerable.Empty<CountryModel>();
            var query = _counties.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(_search))
            {
                query = query.Where(c => (c.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));
            }
            return query;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _counties = await CountyService.GetAllAsync();

        if (_counties != null && (_counties.Count > 0))
        {
            if (CountyGameService.Counties == null || CountyGameService.Counties.Count == 0)
            {
                CountyGameService.Counties = _counties;
            }
            else
            {
                MergeFromGameService();
            }
        }

        CountyGameService.CountyConquered += OnCountyConquered;
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            MergeFromGameService();
        }
        return Task.CompletedTask;
    }

    private void MergeFromGameService()
    {
        if (_counties == null || CountyGameService.Counties == null) return;
        foreach (var county in _counties)
        {
            var match = CountyGameService.Counties.FirstOrDefault(c => string.Equals(c.Code, county.Code, StringComparison.OrdinalIgnoreCase));
            if (match != null)
            {
                county.IsConquered = match.IsConquered;
                county.Owner = match.Owner;
                county.Color = match.Color;
            }
        }
    }

    private async Task OnCountyClicked(CountryModel county)
    {
        if (county == null) return;
        if (!county.IsConquered) return;
        try
        {
            var id = string.IsNullOrWhiteSpace(county.Code) ? county.Name : county.Code;
            if (!string.IsNullOrWhiteSpace(id))
            {
                await JS.InvokeVoidAsync("mapInterop.zoomToCountry", id);
            }
        }
        catch { }
    }

    private void OnCountyConquered(string code)
    {
        if (string.IsNullOrEmpty(code) || _counties == null) return;
        var match = _counties.FirstOrDefault(c => string.Equals(c.Code, code, StringComparison.OrdinalIgnoreCase));
        if (match != null)
        {
            match.IsConquered = true;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        CountyGameService.CountyConquered -= OnCountyConquered;
    }
}
