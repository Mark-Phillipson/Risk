
@page "/kent-towns"
@using System.Linq
@using WorldConquestGame.Shared.Models
@using WorldConquestGame.Client.Pages
@using WorldConquestGame.Client.Shared

@inject IJSRuntime JS
@inject WorldConquestGame.Client.Services.KentTownGameService TownGameService
@inject WorldConquestGame.Client.Services.KentTownService TownService
@implements IDisposable


<div class="map-page" style="display:flex;flex-direction:row;height:100vh;">
    <div class="sidebar-panel" style="width:@(ShowList ? "320px" : "36px");transition:width 0.3s;display:flex;flex-direction:column;z-index:10;position:relative;">
        <button class="sidebar-toggle btn btn-sm btn-primary" title="Toggle towns panel" @onclick="ToggleList" style="width:36px;height:36px;position:absolute;top:8px;left:0;z-index:20;display:flex;align-items:center;justify-content:center;">
            @if (ShowList)
            {
                <i class="bi bi-chevron-left" style="font-size:1.5rem;"></i>
            }
            else
            {
                <i class="bi bi-chevron-right" style="font-size:1.5rem;"></i>
            }
        </button>
        <div style="flex:1 1 auto;overflow:auto;margin-top:52px;@(ShowList ? "" : "display:none;")">
            @if (ShowList)
            {
                <WorldConquestGame.Client.Pages.KentTownList @ref="TownListRef" />
            }
        </div>
    </div>
    <div style="flex:1 1 auto;position:relative;">
        <div id="kent-town-map" class="map" style="height:100%;width:100%;position:relative;"></div>
        
        <!-- Zoom Control Dropdown -->
        <div style="position:absolute;top:10px;right:10px;z-index:1000;background:white;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);padding:8px;">
            <label style="margin:0;font-size:14px;font-weight:500;display:block;margin-bottom:4px;">Zoom Level:</label>
            <select @bind="SelectedZoomLevel" @bind:after="OnZoomLevelChanged" style="padding:4px 8px;border:1px solid #ccc;border-radius:4px;font-size:14px;">
                @foreach (var zoomOption in ZoomOptions)
                {
                    <option value="@zoomOption.Value">@zoomOption.Label</option>
                }
            </select>
        </div>
        
    <WorldConquestGame.Client.Pages.KentTownQuestionPanel />
        <TownGuessModal IsOpen="@IsModalOpen" Title="Identify Town or Village" Question="What town or village is this?" CorrectAnswer="@ModalCorrectAnswer" OnSubmit="OnModalSubmit" OnClose="OnModalClose" />
    </div>
</div>


@code {
    private DotNetObjectReference<KentTownsMap>? objRef;
    private bool ShowList = true;
    private KentTownList? TownListRef;
    private bool _initialized;

        private bool IsModalOpen = false;
        private string ModalCorrectAnswer = "";
        private string ModalPinId = "";

    // Zoom control properties
    private double SelectedZoomLevel = 9.0;
    private List<ZoomOption> ZoomOptions = new();
    
    private class ZoomOption
    {
        public double Value { get; set; }
        public string Label { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        // Generate zoom options - create 10% increments from min to max
        // Leaflet default zoom range is typically 0-18
        double minZoom = 1.0;
        double maxZoom = 18.0;
        double range = maxZoom - minZoom;
        
        // Create 11 options (0%, 10%, 20%, ..., 100%)
        for (int percentage = 0; percentage <= 100; percentage += 10)
        {
            double zoomValue = minZoom + (range * percentage / 100.0);
            ZoomOptions.Add(new ZoomOption 
            { 
                Value = Math.Round(zoomValue, 1), 
                Label = $"{percentage}% (Zoom {Math.Round(zoomValue, 1)})" 
            });
        }
    }

    private async Task OnZoomLevelChanged()
    {
        try
        {
            await JS.InvokeVoidAsync("mapInterop.setZoom", SelectedZoomLevel);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[KentTownsMap] Error setting zoom: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("sessionStorage.setItem", "showCountryLabels", "false");
            
            // Load 20 random towns first
            await EnsureTownsLoadedAsync();
            
            // Force the sidebar list to re-render now that towns are loaded
            StateHasChanged();
            
            // Get the list of town names to pass to the map
            var townNames = TownGameService.Towns.Select(t => t.Name).ToArray();
            
            // All pins start as red - pass the filtered town names to the map
            await JS.InvokeVoidAsync("mapInterop.initMap", "kent-town-map", "data/kent-towns-villages.geojson", objRef, "#dc3545", townNames);
            
            TownGameService.TownConquered += OnTownConquered;
            TownGameService.ResetRequested += OnResetRequested;

            try
            {
                var moved = await JS.InvokeAsync<bool>("mapInterop.setView", 51.2787, 0.5217, 9.0); // Kent center
                if (!moved)
                {
                    await Task.Delay(250);
                    await JS.InvokeAsync<bool>("mapInterop.setView", 51.2787, 0.5217, 9.0);
                }
                
                // Set initial zoom level in dropdown
                SelectedZoomLevel = 9.0;
            }
            catch(Exception exception) { 
                Console.WriteLine($"[KentTownsMap] Exception setting map view: {exception}");
            }

            if (TownGameService.Players.Count == 0)
            {
                TownGameService.Players.Add(new Player { Name = "Player 1" });
                TownGameService.Players.Add(new Player { Name = "Player 2" });
            }

            _initialized = true;
        }
    }

    [JSInvokable("OnCountryClicked")]
    public async Task OnTownClicked(string id)
    {
        // Find the correct town name
        var town = TownGameService.Towns.FirstOrDefault(t => string.Equals(t.Code, id, StringComparison.OrdinalIgnoreCase));
        if (town != null)
        {
            ModalCorrectAnswer = town.Name;
            ModalPinId = id;
            IsModalOpen = true;
            StateHasChanged();
            // Wait for modal to render, then set focus
            await Task.Delay(50);
            await JS.InvokeVoidAsync("mapInterop.focusElement", "town-modal-input", true);
        }
    }
    private async Task OnModalSubmit(string answer)
    {
        // Mark pin as green
        await JS.InvokeAsync<object?>("mapInterop.setCountryConqueredAny", new[] { ModalPinId }, new[] { "#28a745" });
        // Optionally update model
        var town = TownGameService.Towns.FirstOrDefault(t => string.Equals(t.Code, ModalPinId, StringComparison.OrdinalIgnoreCase));
        if (town != null)
        {
            town.IsConquered = true;
            town.Color = "#28a745";
        }
        IsModalOpen = false;
        StateHasChanged();
    }

    public async Task OnModalClose()
    {
        Console.WriteLine("[KentTownsMap] OnModalClose called. Setting IsModalOpen=false");
        IsModalOpen = false;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void ToggleList()
    {
        ShowList = !ShowList;
    }

    private async Task EnsureTownsLoadedAsync()
    {
        if (_initialized) return;
        try
        {
            // Get 20 random towns
            var towns = await TownService.GetRandomSubsetAsync(20);
            Console.WriteLine($"[KentTownsMap] Loaded towns count: {towns?.Count ?? 0}"); // DEBUG: Output loaded town count
            if (towns != null && towns.Count > 0)
            {
                Console.WriteLine($"[KentTownsMap] Selected towns for game: {string.Join(", ", towns.Select(t => t.Name))}");
                TownGameService.Towns = towns;
                TownGameService.NotifyTownsLoaded();
            }
        }
        catch(Exception exception) { 
            Console.WriteLine($"[KentTownsMap] Exception loading towns: {exception}");
        }
    }

    private void OnTownConquered(string id)
    {
        if (string.IsNullOrEmpty(id)) return;
        _ = InvokeAsync(async () =>
        {
            try
            {
                var towns = TownGameService.Towns;
                var match = towns.FirstOrDefault(t => string.Equals(t.Code, id, StringComparison.OrdinalIgnoreCase) || string.Equals(t.Name, id, StringComparison.OrdinalIgnoreCase));
                var color = match?.Color;
                if (string.IsNullOrEmpty(color)) color = "#28a745";
                await JS.InvokeAsync<object?>("mapInterop.setCountryConqueredAny", new[] { id }, new[] { color });
                if (match != null && !string.Equals(match.Code, id, StringComparison.OrdinalIgnoreCase) && !string.IsNullOrEmpty(match.Code))
                {
                    await JS.InvokeAsync<object?>("mapInterop.setCountryConqueredAny", new[] { match.Code }, new[] { color });
                }
                // Persist towns if needed
            }
            catch { }
        });
    }

    private void OnResetRequested()
    {
        _ = InvokeAsync(async () =>
        {
            try
            {
                await JS.InvokeVoidAsync("console.log", "[Blazor] OnResetRequested called in KentTownsMap");
                try
                {
                    foreach (var t in TownGameService.Towns)
                    {
                        t.IsConquered = false;
                        t.Owner = string.Empty;
                        t.Color = string.Empty;
                    }
                }
                catch { }
                try { await JS.InvokeVoidAsync("mapInterop.clearConquered"); } catch { }
                // Clear persisted storage for towns if implemented
                StateHasChanged();
            }
            catch { }
        });
    }

    public void Dispose()
    {
        TownGameService.TownConquered -= OnTownConquered;
        TownGameService.ResetRequested -= OnResetRequested;
        objRef?.Dispose();
    }
}
