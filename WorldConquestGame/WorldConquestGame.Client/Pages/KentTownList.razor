@namespace WorldConquestGame.Client.Pages
@using System.Linq
@using CountryModel = WorldConquestGame.Shared.Models.Country
@inject WorldConquestGame.Client.Services.KentTownService TownService
@inject WorldConquestGame.Client.Services.KentTownGameService TownGameService
@inject IJSRuntime JS
@implements IDisposable

<div class="towns-component" style="display:flex;flex-direction:column;height:100%;">
    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
        <h4 style="margin:0;flex:0 0 auto;">@Title</h4>
        <input class="form-control" placeholder="Search town/village" style="flex:1 1 auto;min-width:0;" @bind="_search" />
    </div>

    @if (TownGameService.Towns == null || !TownGameService.Towns.Any())
    {
        <p>Loading townsâ€¦</p>
    }
    else
    {
        <ul class="town-list" style="list-style:none;padding-left:0;margin:0;overflow:auto;flex:1 1 auto;">
            @foreach (var town in Filtered.OrderBy(t => t.Name))
            {
                var townRef = _townRefs.ContainsKey(town.Name) ? _townRefs[town.Name] : default(ElementReference);
                <li class="town-list-item" @onclick="(e) => OnTownClicked(town, e)" @ref="@townRef">
                    @if (town.IsConquered)
                    {
                        <span class="conquered">@town.Name</span>
                    }
                    else
                    {
                        <span>@town.Name</span>
                    }
                </li>
                _townRefs[town.Name] = townRef;
            }
        </ul>
    }
</div>

<style>
    .towns-component .conquered { text-decoration: line-through; color: #777; }
    .town-list-item {
        padding: 10px 16px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
    }
    .town-list-item:hover {
        background: #f8f9fa;
    }
</style>

@code {
    [Parameter]
    public string Title { get; set; } = "Kent Places";

    private string _search = string.Empty;

    private IEnumerable<CountryModel> Filtered
    {
        get
        {
            // Use the towns from the game service (already filtered to 20 random towns)
            var query = TownGameService.Towns.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(_search))
            {
                query = query.Where(t => (t.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));
            }
            return query;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"[KentTownList] Using towns from TownGameService, count: {TownGameService.Towns?.Count ?? 0}");
        if (TownGameService.Towns != null && TownGameService.Towns.Count > 0)
        {
            Console.WriteLine($"[KentTownList] Town names from game service: {string.Join(", ", TownGameService.Towns.Select(t => t.Name))}");
        }
        TownGameService.TownConquered += OnTownConquered;
        TownGameService.TownsLoaded += OnTownsLoaded;
        await Task.CompletedTask;
    }

    private Dictionary<string, ElementReference> _townRefs = new();

    private ElementReference GetTownRef(CountryModel town)
    {
        var key = town?.Name ?? "";
        if (!_townRefs.ContainsKey(key))
            _townRefs[key] = default;
        return _townRefs[key];
    }

    private async Task OnTownClicked(CountryModel town, MouseEventArgs e)
    {
        if (town == null) return;
        try
        {
            var id = string.IsNullOrWhiteSpace(town.Code) ? town.Name : town.Code;
            if (!string.IsNullOrWhiteSpace(id))
            {
                await JS.InvokeVoidAsync("mapInterop.zoomToCountry", id);
            }
            // Copy town name to clipboard
            if (!string.IsNullOrWhiteSpace(town.Name))
            {
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", town.Name);
                // Show 'Copied!' tooltip on the clicked list item
                if (_townRefs.TryGetValue(town.Name, out var el))
                {
                    await JS.InvokeVoidAsync("mapInterop.showCopiedTooltip", el);
                }
            }
        }
        catch { }
    }

    private void OnTownConquered(string code)
    {
        StateHasChanged();
    }

    private void OnTownsLoaded()
    {
        Console.WriteLine($"[KentTownList] OnTownsLoaded event received, towns count: {TownGameService.Towns?.Count ?? 0}");
        StateHasChanged();
    }

    public void Dispose()
    {
        TownGameService.TownConquered -= OnTownConquered;
        TownGameService.TownsLoaded -= OnTownsLoaded;
    }
}
