@namespace WorldConquestGame.Client.Pages
@using System.Linq
@using CountryModel = WorldConquestGame.Shared.Models.Country
@inject WorldConquestGame.Client.Services.KentTownService TownService
@inject WorldConquestGame.Client.Services.KentTownGameService TownGameService
@inject IJSRuntime JS
@implements IDisposable

<div class="towns-component" style="display:flex;flex-direction:column;height:100%;">
    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
        <h4 style="margin:0;flex:0 0 auto;">@Title</h4>
        <input class="form-control" placeholder="Search town/village" style="flex:1 1 auto;min-width:0;" @bind="_search" />
    </div>

    @if (_allTowns == null || !_allTowns.Any())
    {
        <p>Loading townsâ€¦</p>
    }
    else
    {
        <ul class="town-list" style="list-style:none;padding-left:0;margin:0;overflow:auto;flex:1 1 auto;">
            @foreach (var town in Filtered.OrderBy(t => t.Name))
            {
                <li class="town-list-item" @onclick="() => OnTownClicked(town)">
                    @if (town.IsConquered)
                    {
                        <span class="conquered">@town.Name</span>
                    }
                    else
                    {
                        <span>@town.Name</span>
                    }
                </li>
            }
        </ul>
    }
</div>

<style>
    .towns-component .conquered { text-decoration: line-through; color: #777; }
    .town-list-item {
        padding: 10px 16px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
    }
    .town-list-item:hover {
        background: #f8f9fa;
    }
</style>

@code {
    [Parameter]
    public string Title { get; set; } = "Kent Towns & Villages";

    private string _search = string.Empty;

    private List<CountryModel> _allTowns = new();

    private IEnumerable<CountryModel> Filtered
    {
        get
        {
            var query = _allTowns.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(_search))
            {
                query = query.Where(t => (t.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));
            }
            // Remove duplicates by town name (case-insensitive)
            return query.GroupBy(t => (t.Name ?? string.Empty).Trim().ToLowerInvariant())
                        .Select(g => g.First())
                        .Select(t => {
                            // Reflect conquered status from game
                            var conquered = TownGameService.Towns?.FirstOrDefault(gt => string.Equals(gt.Name, t.Name, StringComparison.OrdinalIgnoreCase))?.IsConquered ?? false;
                            t.IsConquered = conquered;
                            return t;
                        });
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var loaded = await TownService.GetAllAsync();
        Console.WriteLine($"[KentTownList] Loaded towns count: {loaded?.Count ?? 0}");
        if (loaded != null && loaded.Count > 0)
        {
            _allTowns = loaded;
            Console.WriteLine($"[KentTownList] All loaded town names: {string.Join(", ", _allTowns.Select(t => t.Name))}");
        }
        else
        {
            Console.WriteLine("[KentTownList] No towns loaded from TownService.");
        }
        TownGameService.TownConquered += OnTownConquered;
    }

    private async Task OnTownClicked(CountryModel town)
    {
        if (town == null) return;
        try
        {
            var id = string.IsNullOrWhiteSpace(town.Code) ? town.Name : town.Code;
            if (!string.IsNullOrWhiteSpace(id))
            {
                await JS.InvokeVoidAsync("mapInterop.zoomToCountry", id);
            }
        }
        catch { }
    }

    private void OnTownConquered(string code)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        TownGameService.TownConquered -= OnTownConquered;
    }
}
